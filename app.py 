from flask import Flask, jsonify, send_from_directory
from flask_cors import CORS
import pandas as pd
from datetime import datetime
import os

app = Flask(__name__, static_folder='static')
CORS(app)

def load_data():
    try:
        df = pd.read_csv('data/aqi_data.csv')
        df['timestamp'] = pd.to_datetime(df['timestamp'])
        return df
    except Exception as e:
        print(f"Error loading data: {e}")
        return pd.DataFrame()

@app.route('/api/latest')
def get_latest_data():
    df = load_data()
    if df.empty:
        return jsonify([])
    
    # Get latest reading for each city
    latest_data = df.sort_values('timestamp').groupby('city').last().reset_index()
    return jsonify(latest_data.to_dict(orient='records'))

@app.route('/api/history/<city>')
def get_city_history(city):
    df = load_data()
    if df.empty:
        return jsonify([])
    
    # Get last 24 readings for the specified city
    city_data = df[df['city'] == city].sort_values('timestamp').tail(24)
    return jsonify(city_data.to_dict(orient='records'))

@app.route('/')
def serve_frontend():
    return send_from_directory(app.static_folder, 'index.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8000)))